<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZOLTAR ‚Ä¢ Or√°culo Educativo</title>

  <!-- Tipograf√≠as -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/static/img/coin.png" />
  <link rel="stylesheet" href="/static/visuals.css" />
</head>

<body>
  <div class="fog-overlay"></div>

  <header class="marquee">
    <h1>üîÆ ZOLTAR</h1>
    <p class="subtitle">Fortuna pedag√≥gica en cada respuesta</p>
  </header>

  <main class="panel row">
    <!-- Zoltar Arcade -->
    <section class="zoltar-box" id="zoltarBox">
      <div class="zoltar-frame">
        <img class="zoltar-img" id="zoltarImg" src="/static/img/Zoltar_1.png" alt="Zoltar" />
        <div class="coin-slot" id="coinSlot">
          <img id="coinBtn" src="/static/img/coin.png" alt="Moneda" />
          <div class="slot" id="slot"></div>
        </div>
      </div>
    </section>

    <!-- Chat -->
    <section class="chat">
      <div class="options">
        <div class="switch">
          <label><input type="radio" name="mode" value="simple" checked> Modelo simple</label>
          <label><input type="radio" name="mode" value="rag"> Modelo RAG</label>
        </div>
        <div class="hint">üîë Inserta la moneda para comenzar</div>
      </div>

      <div class="conversation" id="conversation">
        <div class="bubble">Aqu√≠ aparecer√° la respuesta...</div>
      </div>

      <div class="composer">
        <input id="question" type="text" placeholder="Haz tu consulta..." disabled />
        <button id="askBtn" disabled>Consultar</button>
      </div>
    </section>
  </main>

  <footer class="foot">
    Animaci√≥n de Zoltar creada por Naomi Friedman
  </footer>

  <!-- Sonidos -->
  <audio id="soundCoin" src="/static/sounds/coin.mp3" preload="auto"></audio>
  <audio id="soundThinking" src="/static/sounds/thinking.mp3" preload="auto" loop></audio>
  <audio id="soundReveal" src="/static/sounds/reveal.mp3" preload="auto"></audio>

  <!-- JS -->
  <script>
    const zoltarImg = document.getElementById("zoltarImg");
    const zoltarBox = document.getElementById("zoltarBox");
    const soundCoin = document.getElementById("soundCoin");
    const soundReveal = document.getElementById("soundReveal");
    const soundThinking = document.getElementById("soundThinking");

    const questionInput = document.getElementById("question");
    const askBtn = document.getElementById("askBtn");
    const conversation = document.getElementById("conversation");
    const coinBtn = document.getElementById("coinBtn");
    const slot = document.getElementById("slot");

    let hasCoin = false;

    const frames = [
      "/static/img/Zoltar_1.png",
      "/static/img/Zoltar_2.png",
      "/static/img/Zoltar_3.png",
      "/static/img/Zoltar_4.png",
      "/static/img/Zoltar_5.png",
      "/static/img/Zoltar_4.png",
      "/static/img/Zoltar_3.png",
      "/static/img/Zoltar_2.png",
    ];

    const preloaded = [];
    frames.forEach(src => {
      const img = new Image();
      img.src = src;
      preloaded.push(img);
    });

    let animInterval = null;
    let frameIndex = 0;

    function startAnimation() {
      stopAnimation();
      frameIndex = 0;
      zoltarBox.classList.add("thinking");
      zoltarImg.classList.add("zoltar-glow"); // üåü Start glow
      soundThinking.currentTime = 0;
      soundThinking.play().catch(() => {});
      animInterval = setInterval(() => {
        zoltarImg.src = frames[frameIndex];
        frameIndex = (frameIndex + 1) % frames.length;
      }, 150);
    }

    function stopAnimation(success = true) {
      clearInterval(animInterval);
      zoltarImg.src = "/static/img/Zoltar_1.png";
      zoltarBox.classList.remove("thinking");
      zoltarImg.classList.remove("zoltar-glow"); // ‚úã Stop glow
      soundThinking.pause();
      soundThinking.currentTime = 0;
      if (success) {
        soundReveal.currentTime = 0;
        soundReveal.play().catch(() => {});
      }
    }

    // Coin animation
    if (coinBtn && slot) {
      coinBtn.addEventListener("click", () => {
        if (hasCoin) return;

        const coinClone = document.createElement("img");
        coinClone.src = "/static/img/coin.png";
        coinClone.className = "moving-coin";

        const rectCoin = coinBtn.getBoundingClientRect();
        const rectSlot = slot.getBoundingClientRect();

        coinClone.style.position = "fixed";
        coinClone.style.left = `${rectCoin.left}px`;
        coinClone.style.top = `${rectCoin.top}px`;
        coinClone.style.width = `60px`;
        coinClone.style.height = `60px`;
        coinClone.style.pointerEvents = "none";
        coinClone.style.transition = "transform 0.8s ease-in-out, opacity 0.8s ease-in-out";
        coinClone.style.zIndex = "9999";

        document.body.appendChild(coinClone);
        void coinClone.offsetWidth;

        const dx = rectSlot.left - rectCoin.left;
        const dy = rectSlot.top - rectCoin.top;

        coinClone.style.transform = `translate(${dx}px, ${dy}px) scale(0.6) rotate(360deg)`;
        coinClone.style.opacity = "0";

        setTimeout(() => coinClone.remove(), 800);

        hasCoin = true;
        questionInput.disabled = false;
        askBtn.disabled = false;

        zoltarBox.classList.add("thinking");
        soundCoin.currentTime = 0;
        soundCoin.play().catch(() => {});
      });
    }

    async function typeText(text) {
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      conversation.appendChild(bubble);
      conversation.scrollTop = conversation.scrollHeight;

      for (let i = 0; i < text.length; i++) {
        bubble.textContent += text[i];
        await new Promise(res => setTimeout(res, 20));
        conversation.scrollTop = conversation.scrollHeight;
      }
    }

    async function callSimpleLLM(msg) {
      const mode = document.querySelector("input[name='mode']:checked").value;

      const res = await fetch(`/api/generate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: msg,
          mode: mode === "baseline" ? "baseline" : "engineered"
        }),
      });

      const data = await res.json();
      return data.text;
    }

    askBtn.addEventListener("click", async () => {
      const msg = questionInput.value.trim();
      if (!msg || !hasCoin) return;

      const mode = document.querySelector("input[name='mode']:checked").value;

      questionInput.value = "";
      startAnimation();
      await typeText("Zoltar est√° pensando...");

      let data = {};

      try {
        if (mode === "rag") {
          const res = await fetch(`/api/teacher`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: msg }),
          });
          data = await res.json();
        } else {
          const text = await callSimpleLLM(msg);
          data.text = text;
        }

        stopAnimation(true);
        await typeText(data.text || "‚ö†Ô∏è Respuesta inesperada");

        if (mode === "rag" && Array.isArray(data.sources) && data.sources.length > 0) {
          const refs = document.createElement("div");
          refs.className = "refs";
          refs.innerHTML = `
            <strong>üìö Fuentes consultadas:</strong>
            <ul>
              ${data.sources.map(s => `<li>${s}</li>`).join("")}
            </ul>
          `;
          conversation.appendChild(refs);
          conversation.scrollTop = conversation.scrollHeight;
        }

        hasCoin = false;
        questionInput.disabled = true;
        askBtn.disabled = true;

      } catch (err) {
        stopAnimation(false);
        await typeText("‚ùå No se pudo conectar con backend");
        console.error(err);
      }
    });
  </script>
</body>
</html>
