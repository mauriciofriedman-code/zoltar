<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZOLTAR • Oráculo</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0a0611; --bg2:#120a1d; --card:#1a1028;
      --ink:#f2e9ff; --muted:#b6a7d6; --gold:#ffd36e;
      --neon:#8af7ff; --accent:#a26bff;
    }
    body {
      margin:0; font-family:Inter, sans-serif; color:var(--ink);
      background:linear-gradient(180deg, var(--bg), var(--bg2));
      display:flex; flex-direction:column; min-height:100vh;
    }
    header {
      padding:16px; text-align:center; background:#0a0611; border-bottom:1px solid rgba(255,211,110,.2);
    }
    header h1 {
      margin:0; font-family:"Playfair Display",serif; font-weight:900; color:var(--gold);
    }
    .tagline { margin:4px 0 0; color:var(--muted); font-size:14px; }
    main { flex:1; display:flex; justify-content:center; align-items:flex-start; padding:20px; }
    .card {
      background:var(--card); border:1px solid rgba(162,107,255,.35);
      border-radius:18px; padding:20px; max-width:500px; width:100%;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      text-align:center; position:relative;
    }
    .machine img {
      width:100%; border:5px solid var(--gold); border-radius:12px;
      transition: box-shadow .3s;
    }
    .machine.thinking img {
      animation: glowBorder 1.5s infinite alternate;
    }
    @keyframes glowBorder {
      from { box-shadow:0 0 10px var(--gold), inset 0 0 5px var(--gold); }
      to   { box-shadow:0 0 25px var(--gold), inset 0 0 15px var(--gold); }
    }

    .toolbar { margin:12px 0; display:flex; justify-content:center; gap:20px; color:var(--muted); }
    .panel { margin-top:16px; }
    input, button {
      padding:10px; border-radius:8px; border:none; margin:5px;
    }
    input { width:65%; background:#0c0813; color:var(--ink); border:1px solid #38204f; }
    button { cursor:pointer; background:var(--gold); font-weight:bold; color:#000; }
    .output {
      margin-top:15px; min-height:80px; background:#0a0611; color:white;
      padding:10px; border-radius:8px; text-align:left;
    }

    .spark {
      position:absolute; width:6px; height:6px; background:var(--gold);
      border-radius:50%; opacity:0; pointer-events:none;
      animation: fly 1s ease-out forwards;
    }
    @keyframes fly {
      0% { opacity:1; transform:translate(0,0) scale(1); }
      100% { opacity:0; transform:translate(var(--dx), var(--dy)) scale(0.3); }
    }

    footer {
      text-align:center;
      font-size:12px;
      color:var(--muted);
      padding:10px;
      border-top:1px solid rgba(255,211,110,.2);
      background:#0a0611;
    }
    footer span { color:var(--gold); }
  </style>
</head>
<body>
  <header>
    <h1>ZOLTAR</h1>
    <p class="tagline">Fortuna pedagógica en cada respuesta</p>
  </header>

  <main>
    <section class="card">
      <div class="machine" id="machine">
        <img id="zoltarImg" src="img/Zoltar_1.png" alt="Zoltar" />
      </div>

      <div class="toolbar">
        <label><input type="radio" name="mode" value="simple" checked> Modelo simple</label>
        <label><input type="radio" name="mode" value="rag"> Modelo RAG</label>
      </div>

      <div class="panel">
        <input id="question" type="text" placeholder="Haz tu consulta..." disabled />
        <button id="coinBtn">Insertar moneda</button>
        <button id="askBtn" disabled>Consultar</button>
        <div class="output" id="output">Aquí aparecerá la respuesta...</div>
      </div>
    </section>
  </main>

  <footer>
    Animación de Zoltar creada por <span>Naomi Friedman</span>
  </footer>

  <script>
    const BACKEND_URL = window.location.hostname.includes("localhost")
      ? "http://127.0.0.1:8000"
      : "";

    const zoltarImg = document.getElementById("zoltarImg");
    const machineDiv = document.getElementById("machine");
    const coinBtn = document.getElementById("coinBtn");
    const askBtn = document.getElementById("askBtn");
    const question = document.getElementById("question");
    const output = document.getElementById("output");
    const modeRadios = document.querySelectorAll("input[name='mode']");

    const coinSound = new Audio("sounds/coin.mp3");
    const thinkingSound = new Audio("sounds/thinking.mp3");
    thinkingSound.loop = true;
    const revealSound = new Audio("sounds/reveal.mp3");

    const frames = [
      "img/Zoltar_1.png","img/Zoltar_2.png","img/Zoltar_3.png",
      "img/Zoltar_4.png","img/Zoltar_5.png","img/Zoltar_4.png",
      "img/Zoltar_3.png","img/Zoltar_2.png"
    ];
    let frameIndex = 0, animInterval=null;

    function showFrame(i) {
      frameIndex = (i+frames.length)%frames.length;
      zoltarImg.src = frames[frameIndex];
    }
    function startAnim() {
      frameIndex=0; clearInterval(animInterval);
      animInterval=setInterval(()=>showFrame(frameIndex+1),150);
      machineDiv.classList.add("thinking");
      thinkingSound.currentTime=0;
      thinkingSound.play().catch(()=>{});
    }
    function stopAnim() {
      clearInterval(animInterval); animInterval=null;
      zoltarImg.src=frames[0];
      machineDiv.classList.remove("thinking");
      thinkingSound.pause();
    }

    function spawnSparks() {
      for(let i=0;i<15;i++){
        const spark=document.createElement("div");
        spark.className="spark";
        spark.style.left="50%"; spark.style.top="50%";
        spark.style.setProperty("--dx",(Math.random()*200-100)+"px");
        spark.style.setProperty("--dy",(Math.random()*200-100)+"px");
        machineDiv.appendChild(spark);
        setTimeout(()=>spark.remove(),1000);
      }
    }

    let hasCoin=false;
    coinBtn.addEventListener("click",()=>{
      hasCoin=true; question.disabled=false; askBtn.disabled=false;
      output.textContent="Inserta tu pregunta..."; question.focus();
      coinSound.currentTime=0; coinSound.play().catch(()=>{});
      spawnSparks();
    });

    askBtn.addEventListener("click",async()=>{
      if(!hasCoin) return;
      const q = question.value.trim();
      if(!q){ return; }

      hasCoin=false; startAnim();
      output.textContent="Zoltar está pensando...";
      const mode=[...modeRadios].find(r=>r.checked).value;
      const endpoint = mode==="rag" ? "/api/teacher" : "/api/generate";

      try{
        const body = mode==="rag"
          ? { text: q }                          // teacher: solo text (+history opcional)
          : { text: q, mode: "engineered" };     // generate: text + mode

        const res=await fetch(BACKEND_URL+endpoint,{
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify(body)
        });

        if(!res.ok){
          let msg = `Error del backend (${res.status})`;
          try {
            const err = await res.json();
            if(err.detail) msg += `: ${err.detail}`;
          } catch {}
          output.textContent = msg;
          console.error("Respuesta del servidor:", res);
        } else {
          const data=await res.json();
          output.textContent=data.text||"Respuesta vacía.";
        }
      } catch(e){
        await new Promise(r=>setTimeout(r,800));
        output.textContent="No fue posible conectar con el servicio.";
        console.error(e);
      } finally {
        stopAnim();
        revealSound.currentTime=0; revealSound.play().catch(()=>{});
        question.value=""; question.disabled=true; askBtn.disabled=true;
      }
    });
  </script>
</body>
</html>
